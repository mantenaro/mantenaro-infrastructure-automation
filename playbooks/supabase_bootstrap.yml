---
- hosts: supabase
  tasks:
    - name: Clone supabase repository
      ansible.builtin.git:
        repo: https://github.com/supabase/supabase
        dest: /tmp/checkout
        depth: 1
        single_branch: yes
        version: master

    - name: Copy supabase compose file
      ansible.builtin.copy:
        src: /tmp/checkout/docker/
        remote_src: true
        dest: supabase-database/
        directory_mode: 0700
        owner: "{{ ansible_facts['user_id'] }}"
        group: "{{ ansible_facts['user_id'] }}"

    - name: Register "env.example" path
      ansible.builtin.stat:
        path: supabase-database/.env.example
      register: env_example

    - name: Move supabase env file
      command: mv supabase-database/.env.example supabase-database/.env
      when: env_example.stat.exists

      community.docker.docker_compose_v2:
        project_src: supabase-database/
